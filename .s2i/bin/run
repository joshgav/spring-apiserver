#! /usr/bin/env bash

if [[ -v PG_uri ]]; then
    echo "INFO: Setting binding metadata from env vars"

    export SPRING_APPLICATION_JSON="{
        \"spring\": {
            \"datasource\": {
                \"username\": \"${PG_user}\",
                \"password\": \"${PG_password}\",
                \"url\": \"jdbc:postgresql://${PG_host}:${PG_port}/${PG_dbname}\"
            },
            \"security\": {
                \"oauth2\": {
                    \"client\": {
                        \"registration\": {
                            \"oidc\": {
                                \"provider\": \"keycloak\",
                                \"scope\": \"openid\",
                                \"client-secret\": \"${KEYCLOAK_CLIENT_SECRET}\",
                                \"client-id\": \"${KEYCLOAK_CLIENT_ID}\"
                            }
                        },
                        \"provider\": {
                            \"keycloak\": {
                                \"issuer-uri\": \"${KEYCLOAK_ISSUER_URI}\"
                            }
                        }
                    }
                }
            }
        }
    }"
fi

# echo "SPRING_APPLICATION_JSON:"
# echo "${SPRING_APPLICATION_JSON}"

exec java \
    -Dspring.config.additional-location=optional:file:/opt/config/application.yaml \
    -jar ./app.jar
